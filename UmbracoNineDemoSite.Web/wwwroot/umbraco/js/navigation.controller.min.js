function NavigationController($scope,$rootScope,$location,$log,$q,$routeParams,$timeout,$cookies,treeService,appState,navigationService,keyboardService,historyService,eventsService,angularHelper,languageResource,contentTypeResource,editorState){var treeInitPromise=$q.defer();$scope.treeApi={},$scope.onTreeInit=function(){return $scope.treeApi.callbacks.treeNodeExpanded(nodeExpandedHandler),$scope.treeApi.callbacks.treeLoaded(function(args){appState.setTreeState("currentRootNode",args.tree)}),$scope.treeApi.callbacks.treeSynced(function(args){void 0!==args.activate&&!0!==args.activate||appState.setTreeState("selectedNode",args.node)}),$scope.treeApi.callbacks.treeOptionsClick(function(args){args.event.stopPropagation(),args.event.preventDefault(),args.event&&args.event.altKey&&(args.skipDefault=!0),navigationService.showMenu(args)}),$scope.treeApi.callbacks.treeNodeAltSelect(function(args){args.event.stopPropagation(),args.event.preventDefault(),args.skipDefault=!0,navigationService.showMenu(args)}),$scope.treeApi.callbacks.treeNodeSelect(function(args){var n=args.node;if(args.event.stopPropagation(),args.event.preventDefault(),n.metaData&&n.metaData.jsClickCallback&&Utilities.isString(n.metaData.jsClickCallback)&&""!==n.metaData.jsClickCallback){var jsPrefix="javascript:",js;js=n.metaData.jsClickCallback.startsWith(jsPrefix)?n.metaData.jsClickCallback.substr(jsPrefix.length):n.metaData.jsClickCallback;try{var func=eval(js);null!=func&&"function"==typeof func&&func.call()}catch(ex){$log.error("Error evaluating js callback from legacy tree node: "+ex)}}else n.routePath?(historyService.add({name:n.name,link:n.routePath,icon:n.icon}),appState.setTreeState("selectedNode",args.node),$location.path(n.routePath),navigationService.clearSearch()):n.section&&($location.path(n.section),navigationService.clearSearch());navigationService.hideNavigation()}),treeInitPromise.promise},$scope.showContextMenuDialog=!1,$scope.showContextMenu=!1,$scope.showSearchResults=!1,$scope.menuDialogTitle=null,$scope.menuActions=[],$scope.menuNode=null,$scope.languages=[],$scope.selectedLanguage={},$scope.page={},$scope.page.languageSelectorIsOpen=!1,$scope.currentSection=null,$scope.customTreeParams=null,$scope.treeCacheKey="_",$scope.showNavigation=appState.getGlobalState("showNavigation");var expandedPaths=[];keyboardService.bind("ctrl+shift+s",function(){navigationService.showSearch()});var isInit=!1,evts=[];function ensureMainCulture(){if(!$location.search().mculture){var language=lastLanguageOrDefault();language&&$timeout(function(){$scope.selectLanguage(language)})}}function configureTreeAndLanguages(){if("content"===$scope.currentSection){var mainCulture=$location.search().mculture;if(mainCulture&&$scope.languages&&$scope.languages.length>1){var found=_.find($scope.languages,function(l){return!0!==mainCulture&&l.culture.toLowerCase()===mainCulture.toLowerCase()});found&&(found.active=!0,$scope.selectedLanguage=found)}var queryParams={};$scope.selectedLanguage&&$scope.selectedLanguage.culture&&(queryParams.culture=$scope.selectedLanguage.culture,mainCulture||$location.search("mculture",$scope.selectedLanguage.culture));var queryString=$.param(queryParams)}queryString?($scope.customTreeParams=queryString,$scope.treeCacheKey=queryString):$scope.treeCacheKey="_"}function ensureInit(){if(!isInit){isInit=!0;var navInit=!1;$rootScope.$on("$routeChangeSuccess",function(){$routeParams.section&&(navInit||(navInit=!0,initNav()),$scope.currentSection!=$routeParams.section&&appState.setSectionState("currentSection",$routeParams.section))})}}function loadLanguages(){return contentTypeResource.allowsCultureVariation().then(function(b){return!0===b?languageResource.getAll():$q.when([])})}function initNav(){loadLanguages().then(function(languages){if($scope.languages=languages,$scope.languages.length>1){var language=null,mainCulture=$location.search().mculture;mainCulture&&(language=_.find($scope.languages,function(l){return l.culture.toLowerCase()===mainCulture.toLowerCase()})),language||(language=lastLanguageOrDefault())&&$location.search("mculture",language.culture)}$scope.currentSection=$routeParams.section,configureTreeAndLanguages(),treeInitPromise.resolve({section:$scope.currentSection,customTreeParams:$scope.customTreeParams,cacheKey:$scope.treeCacheKey,onLoaded:function(){eventsService.emit("app.navigationReady",{treeApi:$scope.treeApi})}})})}function lastLanguageOrDefault(){if(!$scope.languages||$scope.languages.length<=1)return null;var lastCulture=$cookies.get("UMB_MCULTURE"),language=lastCulture?_.find($scope.languages,function(l){return l.culture.toLowerCase()===lastCulture.toLowerCase()}):null;return language||(language=_.find($scope.languages,function(l){return l.isDefault})),language}function nodeExpandedHandler(args){args.node&&treeService._trackExpandedPaths(args.node,expandedPaths)}evts.push(eventsService.on("appState.globalState.changed",function(e,args){"showNavigation"===args.key&&($scope.showNavigation=args.value)})),evts.push(eventsService.on("appState.menuState.changed",function(e,args){"showMenuDialog"===args.key&&($scope.showContextMenuDialog=args.value),"dialogTemplateUrl"===args.key&&($scope.dialogTemplateUrl=args.value),"showMenu"===args.key&&($scope.showContextMenu=args.value),"dialogTitle"===args.key&&($scope.menuDialogTitle=args.value),"menuActions"===args.key&&($scope.menuActions=args.value),"currentNode"===args.key&&($scope.menuNode=args.value)})),evts.push(eventsService.on("appState.treeState.changed",function(e,args){"currentRootNode"===args.key&&(args.value.root&&!1===args.value.root.containsTrees?$rootScope.emptySection=!0:$rootScope.emptySection=!1)})),evts.push(eventsService.on("appState.sectionState.changed",function(e,args){"currentSection"===args.key&&$scope.currentSection!=args.value&&navigationService.waitForNavReady().then(()=>{$scope.currentSection=args.value,configureTreeAndLanguages(),$scope.treeApi.load({section:$scope.currentSection,customTreeParams:$scope.customTreeParams,cacheKey:$scope.treeCacheKey})}),"showSearchResults"===args.key&&($scope.showSearchResults=args.value)})),evts.push(eventsService.on("editors.languages.languageDeleted",function(e,args){loadLanguages().then(function(languages){$scope.languages=languages;const defaultCulture=$scope.languages[0].culture;if(args.language.culture===$scope.selectedLanguage.culture){$scope.selectedLanguage=defaultCulture,$scope.languages.length>1?$location.search("mculture",defaultCulture):$location.search("mculture",null);var currentEditorState=editorState.getCurrent();currentEditorState&&currentEditorState.path&&$scope.treeApi.syncTree({path:currentEditorState.path,activate:!0})}})})),evts.push(eventsService.on("editors.languages.languageSaved",function(e,args){args.isNew?loadLanguages().then(function(languages){$scope.languages=languages}):args.language.isDefault&&loadLanguages().then(function(languages){$scope.languages=languages})})),evts.push(eventsService.on("app.notAuthenticated",function(){$scope.authenticated=!1})),evts.push(eventsService.on("app.ready",function(evt,data){$scope.authenticated=!0,ensureInit(),ensureMainCulture()})),evts.push(eventsService.on("appState.editors.open",function(name,args){$scope.infiniteMode=!!(args&&args.editors.length>0)})),evts.push(eventsService.on("appState.editors.close",function(name,args){$scope.infiniteMode=!!(args&&args.editors.length>0)})),evts.push(eventsService.on("treeService.removeNode",function(e,args){var currentEditorState=editorState.getCurrent();if(currentEditorState&&currentEditorState.id.toString()===args.node.id.toString()){var section=appState.getSectionState("currentSection");$location.path("/"+section)}})),$scope.selectLanguage=function(language){$location.search("mculture",language.culture);var expireDate=new Date;expireDate.setDate(expireDate.getDate()+365),$cookies.put("UMB_MCULTURE",language.culture,{path:"/",expires:expireDate}),$scope.page.languageSelectorIsOpen=!1,configureTreeAndLanguages(),$scope.treeApi.load({section:$scope.currentSection,customTreeParams:$scope.customTreeParams,cacheKey:$scope.treeCacheKey}).then(function(){var currNode=appState.getTreeState("selectedNode"),promises=[];if(currNode){var path=treeService.getPath(currNode);promises.push($scope.treeApi.syncTree({path:path,activate:!0}))}Utilities.forEach($scope.languages,language=>{language.active=!1}),language.active=!0,angularHelper.executeSequentialPromises(promises)})},$scope.searchShowMenu=function(ev,args){args.skipDefault=!0,navigationService.showMenu(args)},$scope.searchHide=function(){navigationService.hideSearch()};var treeActive=!1;function closeTree(){appState.getGlobalState("touchDevice")||(treeActive=!1,$timeout(function(){treeActive||navigationService.hideTree()},300))}$scope.enterTree=function(event){treeActive=!0},$scope.leaveTree=function(event){event&&closeTree()},$scope.onOutsideClick=function(){closeTree()},$scope.toggleLanguageSelector=function(){$scope.page.languageSelectorIsOpen=!$scope.page.languageSelectorIsOpen},$scope.$on("$destroy",function(){for(var e in evts)eventsService.unsubscribe(evts[e])})}angular.module("umbraco").controller("Umbraco.NavigationController",NavigationController);