!function(){"use strict";angular.module("umbraco.install",["umbraco.directives"]),angular.module("umbraco.install").controller("Umbraco.InstallerController",function($scope,installerService){$scope.stepIndex=0,installerService.init(),$scope.installer=installerService.status,$scope.forward=function(){installerService.forward()},$scope.backward=function(){installerService.backward()},$scope.install=function(){installerService.install()},$scope.gotoStep=function(step){installerService.gotoNamedStep(step)},$scope.restart=function(){installerService.gotoStep(0)}}),angular.module("umbraco.install").run(function($templateCache){$templateCache.removeAll()}),angular.module("umbraco.install").factory("installerService",function($rootScope,$q,$timeout,$http,$templateRequest){var factTimer,_status={index:0,current:null,steps:null,loading:!0,progress:"100%"},_installerModel={installId:null,instructions:{}},facts=["Umbraco helped millions of people watch a man jump from the edge of space","Over 500 000 websites are currently powered by Umbraco","At least 2 people have named their cat 'Umbraco'","On an average day more than 1000 people download Umbraco","<a target='_blank' rel='noopener' href='https://umbraco.tv/'>umbraco.tv</a> is the premier source of Umbraco video tutorials to get you started","You can find the world's friendliest CMS community at <a target='_blank' rel='noopener' href='https://our.umbraco.com/'>our.umbraco.com</a>","You can become a certified Umbraco developer by attending one of the official courses","Umbraco works really well on tablets","You have 100% control over your markup and design when crafting a website in Umbraco","Umbraco is the best of both worlds: 100% free and open source, and backed by a professional and profitable company","There's a pretty big chance you've visited a website powered by Umbraco today","'Umbraco-spotting' is the game of spotting big brands running Umbraco","At least 4 people have the Umbraco logo tattooed on them","'Umbraco' is the Danish name for an allen key","Umbraco has been around since 2005, that's a looong time in IT","More than 700 people from all over the world meet each year in Denmark in May for our annual conference <a target='_blank' rel='noopener' href='https://umbra.co/codegarden'>CodeGarden</a>","While you are installing Umbraco someone else on the other side of the planet is probably doing it too","You can extend Umbraco without modifying the source code using either JavaScript or C#","Umbraco has been installed in more than 198 countries"];function resolveView(view){return view.indexOf(".html")<0&&(view+=".html"),view.indexOf("/")<0&&(view="views/install/"+view),view}var service={status:_status,init:function init(){service.status.loading=!0,_status.all||$templateRequest("views/install/error.html").then(function(x){service.getSteps().then(function(response){service.status.steps=response.data.steps,service.status.index=0,_installerModel.installId=response.data.installId,service.findNextStep(),$timeout(function(){service.status.loading=!1,service.status.configuring=!0},2e3)})})},getPackages:function getPackages(){return $http.get(Umbraco.Sys.ServerVariables.installApiBaseUrl+"GetPackages")},getSteps:function getSteps(){return $http.get(Umbraco.Sys.ServerVariables.installApiBaseUrl+"GetSetup")},gotoStep:function gotoStep(index){var step=service.status.steps[index];step.view=resolveView(step.view),step.model||(step.model={}),service.status.index=index,service.status.current=step,service.retrieveCurrentStep()},gotoNamedStep:function gotoNamedStep(stepName){var step=_.find(service.status.steps,function(s,index){return!(!s.view||s.name!==stepName)&&(service.status.index=index,!0)});step.view=resolveView(step.view),step.model||(step.model={}),service.retrieveCurrentStep(),service.status.current=step},findNextStep:function findNextStep(){var step=_.find(service.status.steps,function(s,index){return!!(s.view&&index>=service.status.index)&&(service.status.index=index,!0)});return step?(step.view.indexOf(".html")<0&&(step.view=step.view+".html"),step.view.indexOf("/")<0&&(step.view="views/install/"+step.view),step.model||(step.model={}),service.status.current=step,service.retrieveCurrentStep(),step):null},storeCurrentStep:function storeCurrentStep(){_installerModel.instructions[service.status.current.name]=service.status.current.model},retrieveCurrentStep:function retrieveCurrentStep(){_installerModel.instructions[service.status.current.name]&&(service.status.current.model=_installerModel.instructions[service.status.current.name])},forward:function forward(){service.storeCurrentStep(),service.status.index++,service.findNextStep()||service.install()},backwards:function backwards(){service.storeCurrentStep(),service.gotoStep(service.status.index--)},install:function install(){service.storeCurrentStep(),service.switchToFeedback(),service.status.feedback=function getDescriptionForStepAtIndex(steps,index){var sorted=_.sortBy(steps,"serverOrder");return sorted[index]?sorted[index].description:null}(service.status.steps,0),service.status.progress=0,function processInstallStep(){$http.post(Umbraco.Sys.ServerVariables.installApiBaseUrl+"PostPerformInstall",_installerModel).then(function(response){var data=response.data;if(data.complete)service.complete();else if(service.status.progress=function calculateProgress(steps,next){for(var sorted=_.sortBy(steps,"serverOrder"),pct="100%",i=sorted.length-1;i>=0;i--)if(sorted[i].name==next){pct=Math.floor((i+1)/steps.length*100)+"%";break}return pct}(service.status.steps,data.nextStep),data.view){var v=resolveView(data.view);service.status.current={view:v,model:data.model},service.switchToConfiguration()}else{var desc=function getDescriptionForStepName(steps,name){var found=_.find(steps,function(i){return i.name==name});return found?found.description:null}(service.status.steps,data.nextStep);desc&&(service.status.feedback=desc),processInstallStep()}},handleErrorResponse)}()},randomFact:function randomFact(){!function safeApply(scope,fn){scope.$$phase||scope.$root.$$phase?Utilities.isFunction(fn)&&fn():Utilities.isFunction(fn)?scope.$apply(fn):scope.$apply()}($rootScope,function(){service.status.fact=facts[_.random(facts.length-1)]})},switchToFeedback:function switchToFeedback(){service.status.current=null,service.status.loading=!0,service.status.configuring=!1,service.randomFact(),factTimer=window.setInterval(function(){service.randomFact()},6e3)},switchToConfiguration:function switchToConfiguration(){service.status.loading=!1,service.status.configuring=!0,service.status.feedback=null,service.status.fact=null,factTimer&&clearInterval(factTimer)},complete:function complete(){$http.post(Umbraco.Sys.ServerVariables.installApiBaseUrl+"CompleteInstall",_installerModel).then(function(){service.status.progress="100%",service.status.done=!0,service.status.feedback="Restarting and redirecting you to Umbraco, please wait",service.status.loading=!1,factTimer&&clearInterval(factTimer),window.location.href=Umbraco.Sys.ServerVariables.umbracoBaseUrl},handleErrorResponse)}},handleErrorResponse=function handleErrorResponse(response){var data=response.data,status=response.status;if(status>=500&&status<600){service.status.current={view:"ysod",model:null};var ysod=data;$timeout(function(){document.getElementById("ysod").contentDocument.write(ysod)},500)}else{var v=data.view?resolveView(data.view):resolveView("error"),model=data.model?data.model:data;service.status.current={view:v,model:model}}service.switchToConfiguration()};return service}),angular.module("umbraco.install").controller("Umbraco.Installer.DataBaseController",function($scope,$http,installerService){$scope.checking=!1,$scope.invalidDbDns=!1,$scope.dbs=$scope.installer.current.model.databases,(angular.isUndefined(installerService.status.current.model.dbType)||null===installerService.status.current.model.dbType)&&(installerService.status.current.model.dbType=$scope.dbs[0].id),$scope.validateAndForward=function(){if(!$scope.checking&&this.myForm.$valid){$scope.checking=!0,$scope.invalidDbDns=!1;var model=installerService.status.current.model;$http.post(Umbraco.Sys.ServerVariables.installApiBaseUrl+"PostValidateDatabaseConnection",model).then(function(response){!0===response.data?installerService.forward():$scope.invalidDbDns=!0,$scope.checking=!1},function(){$scope.invalidDbDns=!0,$scope.checking=!1})}}}),angular.module("umbraco.install").controller("Umbraco.Installer.PackagesController",function($scope,installerService){installerService.getPackages().then(function(response){$scope.packages=response.data}),$scope.setPackageAndContinue=function(pckId){installerService.status.current.model=pckId,installerService.forward()}}),angular.module("umbraco.install").controller("Umbraco.Install.UserController",function($scope,installerService){if($scope.majorVersion=Umbraco.Sys.ServerVariables.application.version,$scope.passwordPattern=/.*/,$scope.installer.current.model.subscribeToNewsLetter=!1,$scope.installer.current.model.minNonAlphaNumericLength>0){for(var exp="",i=0;i<$scope.installer.current.model.minNonAlphaNumericLength;i++)exp+=".*[\\W].*";exp=exp.replace(".*.*",".*"),$scope.passwordPattern=new RegExp(exp)}$scope.validateAndInstall=function(){installerService.install()},$scope.validateAndForward=function(){this.myForm.$valid&&installerService.forward()}})}();