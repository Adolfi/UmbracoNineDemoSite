!function(){"use strict";angular.module("umbraco.preview",["umbraco.resources","umbraco.services"]).controller("previewController",function($scope,$window,$location,$http){$scope.currentCulture={iso:"",title:"...",icon:"icon-loading"};var cultures=[];function handleFirstTab(evt){9===evt.keyCode&&($scope.tabbingActive=!0,$scope.$digest(),window.removeEventListener("keydown",handleFirstTab),window.addEventListener("mousedown",disableTabbingActive))}function disableTabbingActive(evt){$scope.tabbingActive=!1,$scope.$digest(),window.removeEventListener("mousedown",disableTabbingActive),window.addEventListener("keydown",handleFirstTab)}$scope.tabbingActive=!1;var iframeWrapper=angular.element("#demo-iframe-wrapper"),canvasDesignerPanel=angular.element("#canvasdesignerPanel");function scaleIframeWrapper(){if("fullsize"==$scope.previewDevice.name)iframeWrapper.css({transform:""});else{var wrapWidth=canvasDesignerPanel.width(),wrapHeight=canvasDesignerPanel.height(),wScale=wrapWidth/(iframeWrapper.width()+30),hScale=wrapHeight/(iframeWrapper.height()+30),scale=Math.min(wScale,hScale,1);iframeWrapper.css({transform:"scale("+scale+")"})}}function getParameterByName(name,url){url||(url=$window.location.href),name=name.replace(/[\[\]]/g,"\\$&");var results=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)").exec(url);return results?results[2]?decodeURIComponent(results[2].replace(/\+/g," ")):"":null}if(window.addEventListener("keydown",handleFirstTab),window.addEventListener("resize",scaleIframeWrapper),iframeWrapper.on("transitionend",scaleIframeWrapper),"true"!==getParameterByName("init")){setPageUrl(),$scope.isOpen=!1,$scope.frameLoaded=!1,$scope.valueAreLoaded=!1,$scope.devices=[{name:"fullsize",css:"fullsize",icon:"icon-application-window-alt",title:"Fit browser"},{name:"desktop",css:"desktop shadow",icon:"icon-display",title:"Desktop"},{name:"laptop - 1366px",css:"laptop shadow",icon:"icon-laptop",title:"Laptop"},{name:"iPad portrait - 768px",css:"iPad-portrait shadow",icon:"icon-ipad",title:"Tablet portrait"},{name:"iPad landscape - 1024px",css:"iPad-landscape shadow",icon:"icon-ipad flip",title:"Tablet landscape"},{name:"smartphone portrait - 480px",css:"smartphone-portrait shadow",icon:"icon-iphone",title:"Smartphone portrait"},{name:"smartphone landscape  - 320px",css:"smartphone-landscape shadow",icon:"icon-iphone flip",title:"Smartphone landscape"}],$scope.previewDevice=$scope.devices[0],$scope.sizeOpen=!1,$scope.cultureOpen=!1,$scope.toggleSizeOpen=function(){$scope.sizeOpen=toggleMenu($scope.sizeOpen)},$scope.toggleCultureOpen=function(){$scope.cultureOpen=toggleMenu($scope.cultureOpen)},$scope.windowClickHandler=function(){closeOthers()},window.addEventListener("blur",windowBlurHandler),document.addEventListener("visibilitychange",windowVisibilityHandler),window.addEventListener("beforeunload",beforeUnloadHandler,!1),$scope.$on("$destroy",function(){window.removeEventListener("blur",windowBlurHandler),document.removeEventListener("visibilitychange",windowVisibilityHandler),window.removeEventListener("beforeunload",beforeUnloadHandler)});var hasPreviewDialog=!1;startPreviewSession(),$scope.updatePreviewDevice=function(device){$scope.previewDevice=device},$scope.openInBrowser=function(){!function setCookie(cname,cvalue,exminutes){var d=new Date;d.setTime(d.getTime()+60*exminutes*1e3),document.cookie=cname+"="+cvalue+";expires="+d.toUTCString()+";path=/"}("UMB-WEBSITE-PREVIEW-ACCEPT","true",5),window.open(getPageURL(),"_blank")},$scope.exitPreview=function(){!function resetPreviewSessions(){localStorage.setItem("UmbPreviewSessionAmount",0)}(),window.top.location.href="../preview/end?redir="+encodeURIComponent(getPageURL())},$scope.onFrameLoaded=function(iframe){$scope.frameLoaded=!0,function configureSignalR(iframe){var dirtyContent=!1,visibleContent=!0;if(document.addEventListener("visibilitychange",function(){(visibleContent=!document.hidden)&&dirtyContent&&(dirtyContent=!1,console.log("Visible, reloading."),(iframe.contentWindow||iframe.contentDocument).location.reload())}),!$.connection||$.connection.connectionState!==signalR.HubConnectionState.Connected){$.connection=(new signalR.HubConnectionBuilder).withUrl(Umbraco.Sys.ServerVariables.umbracoUrls.previewHubUrl).withAutomaticReconnect().configureLogging(signalR.LogLevel.Warning).build(),$.connection.on("refreshed",function(message){if(console.log("Notified by SignalR preview hub ("+message+")."),$scope.pageId==message){if(!visibleContent)return console.log("Not visible, will reload."),void(dirtyContent=!0);console.log("Reloading."),(iframe.contentWindow||iframe.contentDocument).location.reload()}else console.log("Not a notification for us ("+$scope.pageId+").")});try{$.connection.start().then(function(){console.log("Connected to SignalR preview hub (ID="+$.connection.connectionId+")")}).catch(function(){console.log("Could not connect to SignalR preview hub.")})}catch(e){console.error("Could not establish signalr connection. Error: "+e)}}}(iframe),function fixExternalLinks(iframe){Array.from(iframe.contentDocument.getElementsByTagName("a")).filter(function(a){return a.hostname!==location.hostname&&!a.target}).forEach(function(a){return a.target="_top"})}(iframe),$scope.currentCultureIso=$location.search().culture||null},$scope.openPreviewDevice=function(){$scope.showDevicesPreview=!0},$scope.changeCulture=function(iso){$location.search().culture!==iso&&($scope.frameLoaded=!1,$scope.currentCultureIso=iso,$location.search("culture",iso),setPageUrl())},$scope.registerCulture=function(iso,title,isDefault){var cultureObject={iso:iso,title:title,isDefault:isDefault};cultures.push(cultureObject)},$scope.$watch("currentCultureIso",function(oldIso,newIso){null!==$scope.currentCultureIso?$scope.currentCulture=cultures.find(function(culture){return culture.iso===$scope.currentCultureIso}):$scope.currentCulture=cultures.find(function(culture){return!0===culture.isDefault})})}function toggleMenu(isCurrentlyOpen){return!1===isCurrentlyOpen&&(closeOthers(),!0)}function closeOthers(){$scope.sizeOpen=!1,$scope.cultureOpen=!1}function windowBlurHandler(){closeOthers(),$scope.$digest()}function windowVisibilityHandler(e){localStorage.getItem("UmbPreviewSessionAmount");!1===document.hidden&&function checkPreviewState(){if(null===function getCookie(cname){for(var name=cname+"=",ca=document.cookie.split(";"),i=0;i<ca.length;i++){for(var c=ca[i];" "==c.charAt(0);)c=c.substring(1);if(0==c.indexOf(name))return c.substring(name.length,c.length)}return null}("UMB_PREVIEW")){if(!0===hasPreviewDialog)return;hasPreviewDialog=!0;var umbLocalizedVars=Object.assign({returnToPreviewHeadline:"Preview website?",returnToPreviewDescription:"You have ended preview mode, do you want to enable it again to view the latest saved version of your website?",returnToPreviewAcceptButton:"Preview latest version",returnToPreviewDeclineButton:"View published version"},$window.umbLocalizedVars),bodyEl=document.getElementsByTagName("BODY")[0],fragment=document.createElement("div"),shadowRoot=fragment.attachShadow({mode:"open"}),style=document.createElement("style");style.innerHTML="\n\n                    /* Webfont: LatoLatin-Bold */\n                    @font-face {\n                        font-family: 'Lato';\n                        src: url('https://fonts.googleapis.com/css2?family=Lato:wght@700&display=swap');\n                        font-style: normal;\n                        font-weight: 700;\n                        font-display: swap;\n                        text-rendering: optimizeLegibility;\n                    }\n\n                    .umbraco-preview-dialog {\n                        position: fixed;\n                        display: flex;\n                        align-items: center;\n                        justify-content: center;\n                        z-index: 99999999;\n                        top:0;\n                        bottom:0;\n                        left:0;\n                        right:0;\n                        overflow: auto;\n                        background-color: rgba(0,0,0,0.6);\n                    }\n\n                    .umbraco-preview-dialog__modal {\n                        background-color: #fff;\n                        border-radius: 6px;\n                        box-shadow: 0 3px 7px rgba(0,0,0,0.3);\n                        margin: auto;\n                        padding: 30px 40px;\n                        width: 100%;\n                        max-width: 540px;\n                        font-family: Lato,Helvetica Neue,Helvetica,Arial,sans-serif;\n                        font-size: 15px;\n                    }\n\n                    .umbraco-preview-dialog__headline {\n                        font-weight: 700;\n                        font-size: 22px;\n                        color: #1b264f;\n                        margin-top:10px;\n                        margin-bottom:20px;\n                    }\n                    .umbraco-preview-dialog__question {\n                        margin-bottom:30px;\n                    }\n                    .umbraco-preview-dialog__modal > button {\n                        display: inline-block;\n                        cursor: pointer;\n                        padding: 8px 18px;\n                        text-align: center;\n                        vertical-align: middle;\n                        border-radius: 3px;\n                        border:none;\n                        font-family: inherit;\n                        font-weight: 700;\n                        font-size: 15px;\n                        float:right;\n                        margin-left:10px;\n\n                        color: #1b264f;\n                        background-color: #f6f1ef;\n                    }\n                    .umbraco-preview-dialog__modal > button:hover {\n                        color: #2152a3;\n                        background-color: #f6f1ef;\n                    }\n                    .umbraco-preview-dialog__modal > button.umbraco-preview-dialog__continue {\n                        color: #fff;\n                        background-color: #2bc37c;\n                    }\n                    .umbraco-preview-dialog__modal > button.umbraco-preview-dialog__continue:hover {\n                        background-color: #39d38b;\n                    }\n                ",shadowRoot.appendChild(style);var con=document.createElement("div");con.className="umbraco-preview-dialog",shadowRoot.appendChild(con);var modal=document.createElement("div");modal.className="umbraco-preview-dialog__modal",modal.innerHTML='<div class="umbraco-preview-dialog__headline">'.concat(umbLocalizedVars.returnToPreviewHeadline,'</div>\n                    <div class="umbraco-preview-dialog__question">').concat(umbLocalizedVars.returnToPreviewDescription,"</div>"),con.appendChild(modal);var declineButton=document.createElement("button");declineButton.type="button",declineButton.innerHTML=umbLocalizedVars.returnToPreviewDeclineButton,declineButton.addEventListener("click",function(){bodyEl.removeChild(fragment),$scope.exitPreview(),hasPreviewDialog=!1}),modal.appendChild(declineButton);var continueButton=document.createElement("button");continueButton.type="button",continueButton.className="umbraco-preview-dialog__continue",continueButton.innerHTML=umbLocalizedVars.returnToPreviewAcceptButton,continueButton.addEventListener("click",function(){bodyEl.removeChild(fragment),function reenterPreviewMode(){$http({method:"POST",url:"../preview/enterPreview",params:{id:$scope.pageId}}),startPreviewSession()}(),hasPreviewDialog=!1}),modal.appendChild(continueButton),bodyEl.appendChild(fragment),continueButton.focus()}}()}function beforeUnloadHandler(e){!function endPreviewSession(){var amountOfPreviewSessions=localStorage.getItem("UmbPreviewSessionAmount")||0;amountOfPreviewSessions--,localStorage.setItem("UmbPreviewSessionAmount",amountOfPreviewSessions),amountOfPreviewSessions<=0&&navigator.sendBeacon("../preview/end")}()}function setPageUrl(){$scope.pageId=$location.search().id||getParameterByName("id");var culture=$location.search().culture||getParameterByName("culture");if($scope.pageId){var query="id="+$scope.pageId;culture&&(query+="&culture="+culture),$scope.pageUrl="frame?"+query}}function getPageURL(){var culture=$location.search().culture||getParameterByName("culture"),relativeUrl="/"+$scope.pageId;return culture&&(relativeUrl+="?culture="+culture),relativeUrl}function startPreviewSession(){var amountOfPreviewSessions=Math.max(localStorage.getItem("UmbPreviewSessionAmount")||0,0);amountOfPreviewSessions++,localStorage.setItem("UmbPreviewSessionAmount",amountOfPreviewSessions)}}).component("previewIFrame",{template:"<div style='width:100%;height:100%;margin:0 auto;overflow:hidden;'><iframe id='resultFrame' src='about:blank' ng-src=\"{{vm.src}}\" frameborder='0'></iframe></div>",controller:function controller($element,$scope,angularHelper){var vm=this;function iframeReady(){var iframe=$element.find("#resultFrame").get(0);!function hideUmbracoPreviewBadge(iframe){iframe&&iframe.contentDocument&&iframe.contentDocument.getElementById("umbracoPreviewBadge")&&(iframe.contentDocument.getElementById("umbracoPreviewBadge").style.display="none")}(iframe),angularHelper.safeApply($scope,function(){vm.onLoaded({iframe:iframe}),$scope.frameLoaded=!0})}vm.$postLink=function(){$element.find("#resultFrame").get(0).addEventListener("load",iframeReady)}},controllerAs:"vm",bindings:{src:"<",onLoaded:"&"}}).config(function($locationProvider){$locationProvider.html5Mode(!1),$locationProvider.hashPrefix("")})}();